---
import BaseLayout from "../layouts/BaseLayout.astro";
import milestonesRaw from "../data/life.json";

const birthDate = new Date("1999-04-19");
const totalWeeks = 60 * 52;
const currentWeek = Math.floor(
    (Date.now() - birthDate.getTime()) / (1000 * 60 * 60 * 24 * 7)
);

const milestones = milestonesRaw.map((m) => {
    const week = Math.floor(
        (new Date(m.date).getTime() - birthDate.getTime()) /
            (1000 * 60 * 60 * 24 * 7)
    );
    return { ...m, week };
});

const colorMap = {
    red: "bg-red/75",
    orange: "bg-orange/75",
    yellow: "bg-yellow/75",
    green: "bg-green/75",
    cyan: "bg-cyan/75",
    blue: "bg-blue/75",
    purple: "bg-purple/75",
    magenta: "bg-magenta/75",
};

function getDotColor(i) {
    const milestone = milestones.find((m) => m.week === i);
    if (i === currentWeek) return "bg-blue/75";
    if (milestone) return colorMap[milestone.color] || "bg-red/75";
    if (i < currentWeek) return "bg-green/25";
    return "bg-ui/60";
}

const { title = "Life", description = "Your life in weeks" } = Astro.props;
---

<BaseLayout title={title} description={description}>
    <section class="container-full">
        <section class="@container mx-auto w-full max-w-6xl">
            <div
                id="life-grid"
                class="mx-auto flex max-w-2xs flex-wrap gap-4 @sm:max-w-xs @md:max-w-sm @lg:max-w-md @xl:max-w-lg @2xl:max-w-xl @3xl:max-w-2xl @4xl:max-w-3xl @5xl:max-w-4xl @6xl:max-w-5xl @7xl:max-w-6xl"
            >
                {
                    Array.from({ length: totalWeeks }).map((_, i) => {
                        const milestone = milestones.find((m) => m.week === i);
                        const color = getDotColor(i);
                        const tooltip =
                            milestone?.label ||
                            (i === currentWeek ? "You are here" : null);

                        return (
                            <div
                                class={`size-4 rounded-full ${color} relative cursor-pointer`}
                                data-tooltip={tooltip || undefined}
                            />
                        );
                    })
                }
            </div>
        </section>
    </section>

    <script>
        const removeTooltip = () => {
            document.querySelectorAll(".tooltip-portal").forEach((t) => {
                t.classList.remove("opacity-100", "translate-y-0");
                t.classList.add("opacity-0", "translate-y-1.5");
                setTimeout(() => t.remove(), 250); // slightly longer fade-out
            });
        };

        const createTooltip = (dot) => {
            const tooltipText = dot?.dataset.tooltip;
            if (!tooltipText) return;

            removeTooltip();

            const rect = dot.getBoundingClientRect();
            const tooltip = document.createElement("div");
            tooltip.className = `
        tooltip-portal fixed z-50 px-2 py-1 rounded-lg
        bg-ui text-tx text-xs font-medium shadow-lg whitespace-nowrap
        opacity-0 translate-y-1.5 transition-all duration-300 ease-[cubic-bezier(0.22,1,0.36,1)]
      `;
            tooltip.textContent = tooltipText;
            document.body.appendChild(tooltip);

            const tooltipRect = tooltip.getBoundingClientRect();
            let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
            let top = rect.top - tooltipRect.height - 10;
            left = Math.max(
                8,
                Math.min(left, window.innerWidth - tooltipRect.width - 8)
            );
            top = Math.max(8, top);

            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;

            // smooth fade-in
            requestAnimationFrame(() => {
                tooltip.classList.remove("opacity-0", "translate-y-1.5");
                tooltip.classList.add("opacity-100", "translate-y-0");
            });

            return tooltip;
        };

        // Mobile tap
        document.addEventListener("click", (e) => {
            const dot = e.target.closest("[data-tooltip]");
            if (!dot) {
                removeTooltip();
                return;
            }
            createTooltip(dot);
            setTimeout(() => removeTooltip(), 2500);
        });

        // Desktop hover
        let hoverTimeout;
        document.addEventListener("mouseover", (e) => {
            const dot = e.target.closest("[data-tooltip]");
            if (!dot) return;
            clearTimeout(hoverTimeout);
            createTooltip(dot);
        });

        document.addEventListener("mouseout", (e) => {
            const dot = e.target.closest("[data-tooltip]");
            if (!dot) return;
            hoverTimeout = setTimeout(removeTooltip, 150);
        });

        window.addEventListener("scroll", removeTooltip);
        window.addEventListener("resize", removeTooltip);
    </script>
</BaseLayout>
